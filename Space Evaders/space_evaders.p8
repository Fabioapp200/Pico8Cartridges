pico-8 cartridge // http://www.pico-8.com
version 35
__lua__
--space evaders v1.0.0
--by fabioapp @ rfcstudios
function _init()
	t=0
	
	ship = {
		sp=1,
		x=60,
		y=100,
		h=5,
		p=0,
		t=0,
		csfx=2,
		imm=false,
		box = {x1=0,y1=0,x2=7,y2=7}
	}
	bullets = {}
	enemies = {}
	explosions = {}
	stars = {}
	
	for i=1,128 do
		add(stars,{
			x=rnd(128),
			y=rnd(128),
			s=rnd(2)+1
		})
	end 
	
	start()
	
end

function respawn()
	local n = flr(rnd(9))+2
	for i=1,n do
		local d = -1
		if rnd(1) < 0.5 then d=1 end
		add(enemies, {
			sp=17,
			m_x=i*16,
			m_y=-20-i*8,
			d=d,
			x=-32,
			y=-32,
			r=12,
			box = {x1=0,y1=0,x2=7,y2=7}
		})
	end
end

function start()
	_update = update_game
	_draw = draw_game
end

function game_over()
	_update = update_over
	_draw = draw_over
end

function update_over()

end

function draw_over()
	cls()
	print("game over", 50, 50,9)
end

function abs_box(s)
	local box = {}
	box.x1 = s.box.x1 + s.x
	box.y1 = s.box.y1 + s.y
	box.x2 = s.box.x2 + s.x
	box.y2 = s.box.y2 + s.y
	return box
end

function coll(a,b)
	--todo
	local box_a = abs_box(a)
	local box_b = abs_box(b)
	
	if box_a.x1 > box_b.x2 or
				box_a.y1 > box_b.y2 or
				box_b.x1 > box_a.x2 or
				box_b.y1 > box_a.y2 then
				return false
	end
	
	return true
end

function explode(x,y)
	add(explosions,
	{x=x,y=y,t=0})
end

function fire()
	local b = {
		sp=3,
		x=ship.x,
		y=ship.y,
		dx=0,
		dy=-5,
		box = {x1=2,y1=0,x2=5,y2=4}
	}
	add(bullets, b)
	sfx(00)
end

function update_game()
	t=t+1

	--turns the ship immortal when
	--it gets in contact with an 
	--enemy
	if ship.imm then
		ship.t += 1
		ship.csfx = 4
		sfx(-2,2)
		sfx(ship.csfx,2)
		if ship.t > 30 then
			ship.imm = false
			ship.t = 0 
		end
	else
	sfx(ship.csfx,2)
	end
	
	for st in all(stars) do
		st.y += st.s
		if st.y >= 128 then
			st.y = 0
			st.x = rnd(128)
		end
	end
	
	for ex in all(explosions) do
		ex.t+=1
		if ex.t==20 then
			del(explosions, ex)
		end
	end
	
	if #enemies <= 0 then
		respawn()
	end
		
	for e in all(enemies) do 
		e.m_y += 1.3
		e.x = e.r*sin(e.d*t/50) + e.m_x
		e.y = e.r*cos(t/50) + e.m_y
		if coll(ship,e)
					and not ship.imm then
					ship.imm = true
					ship.h -= 1
					if ship.h < 0 then
						game_over()
					end
		end
		
		if e.y > 150 then
			del(enemies,e)
		end
		
	end
	
	for b in all(bullets) do
		b.x+=b.dx
		b.y+=b.dy
		if b.x < 0 or b.x > 128 or
					b.y < 0 or b.y > 128 then
						del(bullets, b)
		end
		for e in all(enemies) do
			if coll(b,e) then
				del(enemies,e)
				sfx(1)
				sfx(5)
				ship.p += 1
				explode(e.x,e.y)
			end
		end
	end

	if(t%8<4) then
		ship.sp=1
	else
		ship.sp=2
	end
	
	if btn(0) then ship.x-=spd end
	if btn(1) then ship.x+=spd end
	if btn(2) then ship.y-=spd end
	if btn(3) then ship.y+=spd end
	if btn(5) then
		spd=4
		ship.csfx=3
	else
		spd=2
		ship.csfx=2
	end
	if btnp(4) then fire() end
	
end

function draw_game()
	cls()
	
	for st in all(stars) do
		pset(st.x, st.y,6)
	end
	
	print("score: "..ship.p,10)
	
	if not ship.imm or	t%8 < 4 then
		spr(ship.sp, ship.x, ship.y)
	end
	
	for ex in all(explosions) do
		circ(ex.x,ex.y,ex.t/3,8+ex.t%3)
	end
	
	for b in all(bullets) do 
		spr(b.sp,b.x,b.y)
	end
	
	for e in all(enemies) do
		spr(e.sp, e.x, e.y)
		
	end
	
	for i=1,4 do
		if i<ship.h then
			spr(33, 80+6*i, 3)
		else
			spr(34, 80+6*i, 3)
		end
	end
end
__gfx__
00000000062992600629926000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000628cc826628cc8260072e700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000689cc986689cc986007e2700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000087cc780087cc7800078e700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000087780000877800007e8700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000a8890000988a0000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000009a000000a900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a90000009a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000bbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000bb33bb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb3333bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb7777bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000b7cc7b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000bbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000b0000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000bb00bb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000080800000606000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000828280006565600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000082800000656000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
0aa00aa00aa0aaa0aaa000000000aaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a000a000a0a0a0a0a0000a000000a0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaa0a000a0a0aa00aa0000000000a0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00a0a000a0a0a0a0a0000a000000a0a0000000000000000000000000000000000000000000000000000000080800080800080800080800000000000000000000
aa000aa0aa00a0a0aaa000000000aaa0000000000000000000000000000000000060000000000000000000828280828280828280828280000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000600082800082800082800082800000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000008000008000608000000000000000000000
00000000000000000000000000000000000000000000000000000000000006000000000000000000000000600000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000060000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000060000000000
00000000000000000000000000000000000000000600000000000000000000000000060000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000600000000000000000000000000000000000000600000000000000000000000000000000000000000
00000000000000000000000600000000000000000000000000000000000600000000000000000000000000000000000000060000000000000000000000000000
00000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000006000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000
00000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000060000000000
0000000000006000000000000000000000000000000000000000000000006000000000000bbbb000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb33bb00000000000000000000000000000000000000000000000600
00000000000000000006000000000000000000000000000000000000000000000000000bb3333bb0000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000bb7777bb0000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000b7cc7b00000000000000000600000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000060bbbb000000000000000000000600000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000b0000b00000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb00bb00000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000bbbb00000000000000000000000000000000000006000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000bb33bb0000000000000000000000000000000000000006000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3333bb000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb7777bb000000000000000000000000000000000060000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000b7cc7b0000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000bbbb00000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000b0000b0000000000000000000000000000000000000060000000000
0000000000000000000000000000000000000000000000000000000000000000000000000bb00bb6000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000bbbb00000000000000000000000000000000600600000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000bb33bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000bb3333bb000000000000000006000000000000000000000000000000000000000000000000000000600000000
000000000000000000000000000000000000000bb7777bb000000000000000000000000000000000000000000000000000000000000000000006000000000000
0000000000000000000000000000000000000000b7cc7b0000000000000000000000000000000000060000000000000000000000000000060000000000000000
00000000000000000000000000600000000000000bbbb00000000000000000000000000000000000060000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000b0000b0000000000000000000060000000000060000000000000000060000000000000000000000000000000
0000000000000000000000600000000000000060bb00bb0000000006000000000000000000000000000000000000000000000000000000060000000000000000
000000000000000000000000000600000000060000bbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000bb33bb000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000bb3333bb00000000000000000000000000000060000000000000000000000000006000000000000000000000
0000000000000000000000000000000000000000bb7777bb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000b7cc7b000000000000000000000000000000000000000000000000000060000000000000000000000000000
000000000000000000000000000000000000000000bbbb0000000000000000000000000000000000000000000000060000000000000000000000000000000000
00000000000000000000000000000000060000000b0000b000000000000000000000000000000000060000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000bb00bb000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000bbbb00000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000bb33bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000bb3333bb000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000bb7777bb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000060000000000000000000b7cc7b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000bbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000
0000000000000000000000000b0000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060
0000000000000000000000000bb00bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000006000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000600000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000600000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000006000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000060000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060
60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000006000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000060000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000060000000000000000000000000000000000000000000006000000000000000000000000000000000600060000060000000600000000000000000000000
00000000000000000000000000000000000000000000000000000000000006299260000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000628cc826000000000000000000000000000000000000000000006000006000000000
000000000000000000000000000000000000000000000000000000000000689cc986000000000000000000000000600000000000000000000000000000000000
000000000000000000000000000000000000000000060000000000000000087cc780000000000000000000000000000000000000000000000000000000000000
00000000000000000000000600000000000000000000000000000000000000877800000000000000000000600000000000000000000000000000000000000000
00000000000000000000600000000000000000000000000000000000000000a88900000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000009a000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000060000000006000000000000000000000000a9000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000600060000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000060
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000
00000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000
00000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000600006000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000

__sfx__
000100000860024000130500e050220502b05009050160501f0001f000320001e0001d00032000310003300000000280002b0002b6002b6002c6002d6002e6000000025000000002600000000270002800029000
000100001165000000116500000011650000002a5501c5501b550136501b550000001365000000166501765018650000000000000000000000000000000000000000000000000000000000000000000000000000
000200050371005710057100571005710101002300022000210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020005107100d7100d7100e7100e7100e7102300022000210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002001810020120201402014020020000300006000190201b0201d0201e0201e0200d0000e0001f0202202024020260202802029020180001b0001d0002d0002e00032000340003700038000000000000000000
000200000c000230002d000000001c1001d1002310028100000001c0001d000000003b0002a2002b2002e2000000000000000000000000000000000c02021020000202f020000000000000000000000000000000
__music__
01 04424344

